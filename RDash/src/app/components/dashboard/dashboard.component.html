import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { AuthService } from '../../services/auth.service';
import { ProjectService, Project } from '../../services/project.service';
import { UserService, UserProfile } from '../../services/user.service';

@Component({
  selector: 'app-dashboard',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <div class="dashboard-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="logo">
          <h2>R'DASH</h2>
        </div>
        <nav class="nav-menu">
          <a href="#" class="nav-item active" (click)="setActiveView('projects')">
            <span class="nav-icon">ðŸ“Š</span>
            My Projects
          </a>
          <a href="#" class="nav-item" (click)="setActiveView('tasks')">
            <span class="nav-icon">âœ“</span>
            My Tasks
          </a>
          <a href="#" class="nav-item" *ngIf="isAdmin" (click)="setActiveView('users')">
            <span class="nav-icon">ðŸ‘¥</span>
            Manage Users
          </a>
          <a href="#" class="nav-item" (click)="logout()">
            <span class="nav-icon">ðŸšª</span>
            Logout
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <div class="header">
          <div class="header-left">
            <h1>{{ getPageTitle() }}</h1>
          </div>
          <div class="header-right">
            <button *ngIf="activeView === 'projects' && isAdmin" 
                    class="btn btn-primary" 
                    (click)="showCreateProject = true">
              âž• Add Project
            </button>
            <button *ngIf="activeView === 'users' && isAdmin" 
                    class="btn btn-primary" 
                    (click)="showCreateUser = true">
              âž• Add User
            </button>
            <span class="user-info">{{ currentUser?.email }}</span>
          </div>
        </div>

        <!-- Projects View -->
        <div *ngIf="activeView === 'projects'" class="content-section">
          <!-- Project Status Cards -->
          <div class="status-cards">
            <div class="status-card">
              <div class="card-number">{{ projects.length }}</div>
              <div class="card-label">All Projects</div>
            </div>
            <div class="status-card">
              <div class="card-number">{{ getProjectsByStatus('LL WIP').length }}</div>
              <div class="card-label">LL WIP</div>
            </div>
            <div class="status-card">
              <div class="card-number">{{ getProjectsByStatus('Fitout WIP').length }}</div>
              <div class="card-label">Fitout WIP</div>
            </div>
            <div class="status-card">
              <div class="card-number">{{ getProjectsByStatus('Completed').length }}</div>
              <div class="card-label">Completed</div>
            </div>
          </div>

          <!-- Search and Filters -->
          <div class="filters">
            <input type="text" 
                   placeholder="Search projects..." 
                   [(ngModel)]="searchTerm"
                   class="search-input">
            <select [(ngModel)]="statusFilter" class="filter-select">
              <option value="">All Status</option>
              <option value="LL WIP">LL WIP</option>
              <option value="Fitout WIP">Fitout WIP</option>
              <option value="Completed">Completed</option>
            </select>
          </div>

          <!-- Projects Table -->
          <div class="table-container">
            <table class="projects-table">
              <thead>
                <tr>
                  <th>Store Code</th>
                  <th>Store Name</th>
                  <th>Store Type</th>
                  <th>City</th>
                  <th>State</th>
                  <th>Project Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let project of getFilteredProjects()" 
                    (click)="viewProject(project.id!)"
                    class="project-row">
                  <td>{{ project.store_code }}</td>
                  <td>{{ project.store_name }}</td>
                  <td>
                    <span class="store-type-badge" [ngClass]="'badge-' + project.store_type.toLowerCase().replace(' ', '-')">
                      {{ project.store_type }}
                    </span>
                  </td>
                  <td>{{ project.city }}</td>
                  <td>{{ project.state }}</td>
                  <td>
                    <span class="status-badge" [ngClass]="'status-' + project.project_status.toLowerCase().replace(' ', '-')">
                      {{ project.project_status }}
                    </span>
                  </td>
                  <td>
                    <button class="btn-small btn-outline" (click)="viewProject(project.id!); $event.stopPropagation()">
                      View
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Users Management View -->
        <div *ngIf="activeView === 'users'" class="content-section">
          <div class="table-container">
            <table class="users-table">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Created At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of users">
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="role-badge" [ngClass]="'role-' + user.role.toLowerCase().replace(' ', '-')">
                      {{ user.role }}
                    </span>
                  </td>
                  <td>{{ user.created_at | date:'short' }}</td>
                  <td>
                    <button class="btn-small btn-outline" (click)="editUser(user)">Edit</button>
                    <button class="btn-small btn-danger" (click)="deleteUser(user.id!)" *ngIf="user.role !== 'Super Admin'">Delete</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Project Modal -->
    <div *ngIf="showCreateProject" class="modal-overlay" (click)="showCreateProject = false">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Create New Project</h3>
          <button class="close-btn" (click)="showCreateProject = false">Ã—</button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="createProject()" class="project-form">
            <div class="form-row">
              <div class="form-group">
                <label>Store Code *</label>
                <input type="text" [(ngModel)]="newProject.store_code" name="store_code" required class="form-control">
              </div>
              <div class="form-group">
                <label>Store Name *</label>
                <input type="text" [(ngModel)]="newProject.store_name" name="store_name" required class="form-control">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Project Code *</label>
                <input type="text" [(ngModel)]="newProject.project_code" name="project_code" required class="form-control">
              </div>
              <div class="form-group">
                <label>Zone *</label>
                <input type="text" [(ngModel)]="newProject.zone" name="zone" required class="form-control">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>City *</label>
                <input type="text" [(ngModel)]="newProject.city" name="city" required class="form-control">
              </div>
              <div class="form-group">
                <label>State *</label>
                <input type="text" [(ngModel)]="newProject.state" name="state" required class="form-control">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Store Type *</label>
                <select [(ngModel)]="newProject.store_type" name="store_type" required class="form-control">
                  <option value="">Select Store Type</option>
                  <option value="Dark Store">Dark Store</option>
                  <option value="Super Store">Super Store</option>
                  <option value="CafÃ©">CafÃ©</option>
                </select>
              </div>
              <div class="form-group">
                <label>Site Type *</label>
                <select [(ngModel)]="newProject.site_type" name="site_type" required class="form-control">
                  <option value="">Select Site Type</option>
                  <option value="BTS">BTS</option>
                  <option value="Semi BTS">Semi BTS</option>
                  <option value="RTM">RTM</option>
                  <option value="C&E">C&E</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Project Status *</label>
                <select [(ngModel)]="newProject.project_status" name="project_status" required class="form-control">
                  <option value="">Select Status</option>
                  <option value="LL WIP">LL WIP</option>
                  <option value="Fitout WIP">Fitout WIP</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
              <div class="form-group">
                <label>Property Area (Sqft)</label>
                <input type="number" [(ngModel)]="newProject.property_area_sqft" name="property_area_sqft" class="form-control">
              </div>
            </div>

            <div class="form-group">
              <label>Site Lat/Long</label>
              <input type="text" [(ngModel)]="newProject.site_lat_long" name="site_lat_long" class="form-control" placeholder="e.g., 12.9716, 77.5946">
            </div>

            <div class="form-dates">
              <div class="form-group">
                <label>LL HO Date</label>
                <input type="date" [(ngModel)]="newProject.ll_ho_date" name="ll_ho_date" class="form-control">
              </div>
              <div class="form-group">
                <label>Launch Date</label>
                <input type="date" [(ngModel)]="newProject.launch_date" name="launch_date" class="form-control">
              </div>
              <div class="form-group">
                <label>Project Handover Date</label>
                <input type="date" [(ngModel)]="newProject.project_handover_date" name="project_handover_date" class="form-control">
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline" (click)="showCreateProject = false">Cancel</button>
              <button type="submit" class="btn btn-primary">Create Project</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Create User Modal -->
    <div *ngIf="showCreateUser" class="modal-overlay" (click)="showCreateUser = false">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editingUser ? 'Edit User' : 'Create New User' }}</h3>
          <button class="close-btn" (click)="showCreateUser = false">Ã—</button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="saveUser()" class="user-form">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" [(ngModel)]="newUser.email" name="email" required class="form-control">
            </div>
            
            <div class="form-group" *ngIf="!editingUser">
              <label>Password *</label>
              <input type="password" [(ngModel)]="newUser.password" name="password" required class="form-control">
            </div>

            <div class="form-group">
              <label>Role *</label>
              <select [(ngModel)]="newUser.role" name="role" required class="form-control">
                <option value="">Select Role</option>
                <option value="Admin">Admin</option>
                <option value="Editor">Editor</option>
                <option value="Associate">Associate</option>
                <option value="Ground Team">Ground Team</option>
                <option value="Normal User">Normal User</option>
              </select>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline" (click)="showCreateUser = false">Cancel</button>
              <button type="submit" class="btn btn-primary">{{ editingUser ? 'Update User' : 'Create User' }}</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `,
  styles: [`
    .dashboard-layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .logo {
      padding: 20px;
      border-bottom: 1px solid #34495e;
    }

    .logo h2 {
      margin: 0;
      color: #3498db;
    }

    .nav-menu {
      padding: 20px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: #bdc3c7;
      text-decoration: none;
      transition: all 0.3s;
    }

    .nav-item:hover, .nav-item.active {
      background: #34495e;
      color: white;
    }

    .nav-icon {
      margin-right: 10px;
      width: 20px;
    }

    .main-content {
      margin-left: 250px;
      flex: 1;
      background: #f8f9fa;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      color: #2c3e50;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      color: #6c757d;
      font-size: 14px;
    }

    .content-section {
      padding: 30px;
    }

    .status-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .status-card {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }

    .card-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #3498db;
      margin-bottom: 5px;
    }

    .card-label {
      color: #6c757d;
      font-size: 14px;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }

    .search-input, .filter-select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .search-input {
      flex: 1;
      max-width: 300px;
    }

    .table-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .projects-table, .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .projects-table th, .projects-table td,
    .users-table th, .users-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }

    .projects-table th, .users-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    .project-row {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .project-row:hover {
      background: #f8f9fa;
    }

    .store-type-badge, .status-badge, .role-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-dark-store { background: #6f42c1; color: white; }
    .badge-super-store { background: #28a745; color: white; }
    .badge-cafÃ© { background: #fd7e14; color: white; }

    .status-ll-wip { background: #ffc107; color: #212529; }
    .status-fitout-wip { background: #17a2b8; color: white; }
    .status-completed { background: #28a745; color: white; }

    .role-admin { background: #dc3545; color: white; }
    .role-editor { background: #6f42c1; color: white; }
    .role-associate { background: #28a745; color: white; }
    .role-ground-team { background: #17a2b8; color: white; }
    .role-normal-user { background: #6c757d; color: white; }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-outline {
      background: transparent;
      color: #007bff;
      border: 1px solid #007bff;
    }

    .btn-outline:hover {
      background: #007bff;
      color: white;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
      margin-right: 5px;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px 30px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: #2c3e50;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
    }

    .modal-body {
      padding: 30px;
    }

    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #dee2e6;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .project-form, .user-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-dates {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 5px;
      font-weight: 500;
      color: #495057;
    }

    .form-control {
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: static;
      }

      .main-content {
        margin-left: 0;
      }

      .form-row, .form-dates {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 95%;
        margin: 10px;
      }
    }
  `]
})
export class DashboardComponent implements OnInit {
  activeView = 'projects';
  projects: Project[] = [];
  users: UserProfile[] = [];
  currentUser: any;
  isAdmin = false;

  // Search and filters
  searchTerm = '';
  statusFilter = '';

  // Modals
  showCreateProject = false;
  showCreateUser = false;
  editingUser: UserProfile | null = null;

  // Form data
  newProject: Project = {
    store_code: '',
    store_name: '',
    project_code: '',
    zone: '',
    city: '',
    state: '',
    site_lat_long: '',
    store_type: '',
    site_type: '',
    ll_ho_date: '',
    launch_date: '',
    project_handover_date: '',
    loi_release_date: '',
    token_release_date: '',
    recee_date: '',
    recee_status: '',
    loi_signed_status: '',
    layout: '',
    project_status: '',
    property_area_sqft: 0
  };

  newUser: UserProfile = {
    email: '',
    password: '',
    role: ''
  };

  constructor(
    private authService: AuthService,
    private projectService: ProjectService,
    private userService: UserService,
    private router: Router
  ) { }

  ngOnInit(): void {
    this.currentUser = this.authService.getCurrentUser();
    this.isAdmin = this.authService.isAdmin();

    if (!this.isAdmin) {
      this.router.navigate(['/my-tasks']);
      return;
    }

    this.loadProjects();
    this.loadUsers();
  }

  setActiveView(view: string): void {
    this.activeView = view;
    if (view === 'tasks') {
      this.router.navigate(['/my-tasks']);
    }
  }

  getPageTitle(): string {
    switch (this.activeView) {
      case 'projects': return 'My Projects';
      case 'users': return 'Manage Users';
      default: return 'Dashboard';
    }
  }

  loadProjects(): void {
    this.projectService.getProjects().subscribe({
      next: (response) => {
        if (response.success) {
          this.projects = response.data;
        }
      },
      error: (error) => console.error('Error loading projects:', error)
    });
  }

  loadUsers(): void {
    this.userService.getUsers().subscribe({
      next: (response) => {
        if (response.success) {
          this.users = response.data;
        }
      },
      error: (error) => console.error('Error loading users:', error)
    });
  }

  getProjectsByStatus(status: string): Project[] {
    return this.projects.filter(p => p.project_status === status);
  }

  getFilteredProjects(): Project[] {
    let filtered = this.projects;

    if (this.searchTerm) {
      const term = this.searchTerm.toLowerCase();
      filtered = filtered.filter(p =>
        p.store_code.toLowerCase().includes(term) ||
        p.store_name.toLowerCase().includes(term) ||
        p.city.toLowerCase().includes(term) ||
        p.state.toLowerCase().includes(term)
      );
    }

    if (this.statusFilter) {
      filtered = filtered.filter(p => p.project_status === this.statusFilter);
    }

    return filtered;
  }

  viewProject(projectId: number): void {
    this.router.navigate(['/project', projectId]);
  }

  createProject(): void {
    this.projectService.createProject(this.newProject).subscribe({
      next: (response) => {
        if (response.success) {
          this.showCreateProject = false;
          this.resetProjectForm();
          this.loadProjects();
        }
      },
      error: (error) => console.error('Error creating project:', error)
    });
  }

  resetProjectForm(): void {
    this.newProject = {
      store_code: '',
      store_name: '',
      project_code: '',
      zone: '',
      city: '',
      state: '',
      site_lat_long: '',
      store_type: '',
      site_type: '',
      ll_ho_date: '',
      launch_date: '',
      project_handover_date: '',
      loi_release_date: '',
      token_release_date: '',
      recee_date: '',
      recee_status: '',
      loi_signed_status: '',
      layout: '',
      project_status: '',
      property_area_sqft: 0
    };
  }

  editUser(user: UserProfile): void {
    this.editingUser = user;
    this.newUser = { ...user };
    delete this.newUser.password; // Don't include password in edit
    this.showCreateUser = true;
  }

  saveUser(): void {
    if (this.editingUser) {
      this.userService.updateUser(this.editingUser.id!, this.newUser).subscribe({
        next: (response) => {
          if (response.success) {
            this.showCreateUser = false;
            this.resetUserForm();
            this.loadUsers();
          }
        },
        error: (error) => console.error('Error updating user:', error)
      });
    } else {
      this.userService.createUser(this.newUser).subscribe({
        next: (response) => {
          if (response.success) {
            this.showCreateUser = false;
            this.resetUserForm();
            this.loadUsers();
          }
        },
        error: (error) => console.error('Error creating user:', error)
      });
    }
  }

  deleteUser(userId: number): void {
    if (confirm('Are you sure you want to delete this user?')) {
      this.userService.deleteUser(userId).subscribe({
        next: (response) => {
          if (response.success) {
            this.loadUsers();
          }
        },
        error: (error) => console.error('Error deleting user:', error)
      });
    }
  }

  resetUserForm(): void {
    this.newUser = {
      email: '',
      password: '',
      role: ''
    };
    this.editingUser = null;
  }

  logout(): void {
    this.authService.logout();
  }
}
